<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="UK Council info :: OpenlyLocal"
    directory_title="UK Council info :: OpenlyLocal"
    description="Get info on what your council is doing from OpenlyLocal.com :: making Local Government more transparent"
    author="CountCulture"
    author_affiliation="OpenlyLocal.com"
    author_email="countculture@gmail.com"
    height="250"
    scrolling="true"
    singleton="false"
    author_link="http://OpenlyLocal.com">
    <Require feature="settitle"/>
    <Require feature="tabs"/>
  </ModulePrefs>
  
  <UserPref name="council"  
    display_name="Council" datatype="enum" 
     required="true">
    <EnumValue value="1" 
        display_value="Wandsworth"/>
    <EnumValue value="2" 
        display_value="Merton"/>
    <EnumValue value="187" 
        display_value="Birmingham"/>
  </UserPref>


  <Content type="html">
    <![CDATA[ 
              <style> 
                .collection { font-size: 70%;  padding: 5px; background-color: #FFFFBF;} 
              </style>

              <script type="text/javascript">
                var prefs = new gadgets.Prefs();
                
                // Initialize tabs.
                var tabs = new gadgets.TabSet(__MODULE_ID__);
                                
                function getCouncilData() {
                  var councilId = prefs.getString("council");
                  var params = {};
                  params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.JSON;
                  // This URL returns a JSON-encoded string that represents a JavaScript object
                  var url = "http://openlylocal.com/councils/" + councilId + ".json";
                  gadgets.io.makeRequest(url, insertCouncilData, params);
                };

                
                function insertCouncilData(obj)
                { 
                  var council = obj.data.council;
                  gadgets.window.setTitle(council.name + " :: OpenlyLocal");
                  var memberHtml = "";
                  var committeeHtml = "";
                  for (var i = 0; i < council.members.length; i++) {
                    var m = council.members[i];
                    memberHtml += "<a href='http://openlylocal.com/members/"+ m.id +"'>" + m.first_name + " " + m.last_name + "</a> ("+ m.party.name +")<br />";
                  }    
                 
                  for (var i = 0; i < council.committees.length; i++) {
                    var c = council.committees[i];
                    committeeHtml += "<a href='http://openlylocal.com/committees/"+ c.id +"'>" + c.title + "</a><br />";
                  } 
                  document.getElementById('members').innerHTML = memberHtml;
                  document.getElementById('committees').innerHTML = committeeHtml;
                  
                  tabs.addTab("Members", {
                     contentContainer: document.getElementById("members")
                  });
                  tabs.addTab("Committees", {
                     contentContainer: document.getElementById("committees")
                  });
                  tabs.addTab("Meetings", {
                     contentContainer: document.getElementById("meetings")
                  });

                }

                // Call the init function on page load
                gadgets.util.registerOnLoadHandler(getCouncilData);
                
              </script>
              
              <div id="members" class="collection"><h4>Councillors</h4></div>
              <div id="committees"  class="collection" style="display:none"><h4>Committees</h4></div>
              <div id="meetings"  class="collection" style="display:none"><h4>Meetings</h4></div>
            ]]>
  </Content>
</Module>