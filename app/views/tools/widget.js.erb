(function(){
	var council_id = <%= @council.id %>;
	document.write('<style lang="text/css">div.olwidget {margin:3px;}\n .olwidget h3 { border-bottom: 1px solid #676767; margin: 0.5em 0 0 0; color: #003366;}\n .olwidget h4 { color: #333; margin: 0.5em 0 0 0;}\n .olwidget .footer { padding 5px; background-color: #eee; border-top: 1px solid #676767; margin-top: 1em;}\n.olwidget a {text-decoration: none; color: #003366;}\n .olwidget ul {padding: 10px; margin: 0.5em 0.25em;}</style>');
  
  document.write('<div class="olwidget" id="openlylocal-widget">');

  document.write('Loading...');

  document.write('</div>');
  
  function listItemFor(obj) {
    var li = "<li>";
    li += obj.formatted_date || "";
    li += " <a href='" + (obj.openlylocal_url || obj.url) + "'>";
    li += (obj.title || obj.name || (obj.first_name + " " + obj.last_name));
    li += "</a>" + (obj.party ? " (" + obj.party + ")" : "");
    li += obj.openlylocal_url && obj.url ? (" <a href='" + obj.url + "' class='official_page'>official page</a></li>") : "</li>";
    return li;
  }

  function listAll(coll) { 
    if(coll.length && coll.length > 0){
      var listResult = "<ul>";
      for (var i = 0; i < coll.length && i < 10; i++) {
        var li = coll[i];
        listResult += listItemFor(li);
      }
      listResult += "</ul>";
      return listResult;
    }
    else { return '';}
  }

  function insertCouncilData(data)
  { 
    var council = data.council;
    var partyBreakdown = [];
    var partyBreakdownObj ={};
		var header = '<h3>' + council.name + '</h3><h4>Upcoming meetings</h4>';
    var footer = "<div class='footer'>More details and info at <a href='http://openlylocal.com'>OpenlyLocal</a> :: Making local government more transparent</div>";
		var form = '<form method="get" class="form" action="http://openlylocal.com/areas/search"><label for="postcode">Info on your area:</label><input type="text" name="postcode" id="postcode"><input type="submit" value="Search by postcode" name="submit" id="submit" class="form_submit"></form>';
    $('.olwidget').html(header + listAll(council.meetings) + form + footer);

  }
  
  jQuery.getJSON('http://openlylocal.com/councils/' + council_id +'.json?callback=?', function(data){insertCouncilData(data);});
 })();